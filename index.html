<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>사주위키</title>
  <meta name="description" content="사주의 모든 것, 사주위키에 오신 것을 환영합니다. 사주BTI, 만세력, 궁합, 오늘의 운세 등을 제공합니다.">
  <meta name="keywords" content="사주, 명리, 오행, 운세, 궁합, 사주팔자, 만세력, 사주BTI, 사주위키">

  <!-- Open Graph / 링크 공유 미리보기 -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="사주위키">
  <meta property="og:description" content="사주의 모든 것, 사주위키에 오신 것을 환영합니다. 사주BTI, 만세력, 궁합, 오늘의 운세 등을 제공합니다.">
  <meta property="og:image" content="https://yonsei-saju.vercel.app/og-image.png">
  <meta property="og:url" content="https://yonsei-saju.vercel.app">
  <meta property="og:site_name" content="사주위키">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="사주위키">
  <meta name="twitter:description" content="사주의 모든 것, 사주위키에 오신 것을 환영합니다. 사주BTI, 만세력, 궁합, 오늘의 운세 등을 제공합니다.">

  <!-- Favicon (브라우저 탭 아이콘) -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="css/main.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>


  <!-- Module Script -->
  <script type="module" src="js/app.js?v=20260206"></script>
</head>
<body>
  <!-- 페이지 전체 래퍼 (황토색 배경) -->
  <div class="page-wrapper">

  <!-- ═══════════════════════════════════════════════════════════════════════════
       메인 컨테이너
       ═══════════════════════════════════════════════════════════════════════════ -->
  <!-- 헤더 (container 밖, page-wrapper 최상단) -->
  <header>
    <div class="header-left">
      <img src="logo.png" alt="사주위키 로고" class="header-logo">
      <h1>사주위키</h1>
    </div>
    <!-- 사주 개념 가이드 -->
    <button class="header-guide-btn" onclick="window.__showSajuGuide && window.__showSajuGuide()">
      <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"></path><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"></path></svg>
      사주 개념 가이드
    </button>
    <!-- 키워드 검색 -->
    <div class="header-search" id="header-search">
      <div class="header-search-wrapper">
        <svg class="header-search-icon" viewBox="0 0 24 24" width="16" height="16">
          <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"></circle>
          <path d="M16.5 16.5L21 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
        </svg>
        <input type="text" id="header-search-input" placeholder="키워드 검색..." aria-label="사주위키 키워드 검색">
      </div>
      <div class="header-search-results" id="header-search-results"></div>
    </div>
    <!-- 로그인 버튼 -->
    <div class="header-auth" id="header-auth">
      <button class="btn-login" id="btn-login" onclick="window.__showLoginModal && window.__showLoginModal()">
        <svg class="login-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"></circle><path d="M4 21c0-4.4 3.6-8 8-8s8 3.6 8 8"></path></svg>
        로그인
      </button>
    </div>
  </header>

  <div class="container">
    <div class="main-layout">
      <div class="main-content">
        
        <!-- ═══ 탭 네비게이션 ═══ -->
        <nav class="tab-nav" id="tab-nav">
          <button class="tab-btn" data-tab="today" onclick="switchTab('today')" style="display:none">☀️ 오늘의 운세</button>
          <button class="tab-btn" data-tab="bti" onclick="switchTab('bti')">사주BTI</button>
          <button class="tab-btn active" data-tab="myeongshik" onclick="switchTab('myeongshik')">전문 만세력</button>
          <button class="tab-btn" data-tab="gunghap" onclick="switchTab('gunghap')">궁합</button>
          <button class="tab-btn" data-tab="celeb" onclick="switchTab('celeb')">인물위키</button>
          <button class="tab-btn" data-tab="guestbook" onclick="switchTab('guestbook')">피드백 수납칸</button>
        </nav>

        <!-- ═══════════════════════════════════════════════════════════════════════════
             탭별 헤더 카드
             ═══════════════════════════════════════════════════════════════════════════ -->
        <!-- BTI 헤더 -->
        <div class="tab-top-header" id="bti-top-header" style="display:none">
          <h2>사주BTI</h2>
          <p>당신의 타고난 기질을 MBTI처럼 쉽게 알아보세요. 일간(日干)을 기준으로 10가지 유형 중 나의 성격과 강점을 확인해보세요!</p>
        </div>

        <!-- 전문 만세력 헤더 -->
        <div class="tab-top-header" id="myeongshik-top-header">
          <h2>전문 만세력</h2>
          <p>사주팔자의 전체 구조를 한눈에 확인하세요. 천간/지지의 오행 분포, 십성 관계, 12운성, 대운과 세운까지 상세하게 분석합니다.</p>
        </div>

        <!-- 궁합 헤더 -->
        <div class="tab-top-header" id="gunghap-top-header" style="display:none">
          <h2>두 사람의 궁합 분석</h2>
          <p>상단에서 본인 정보 입력 후, 아래에서 상대 정보를 입력하세요</p>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════════
             사주 계산기
             ═══════════════════════════════════════════════════════════════════════════ -->
        <section class="global-calc" id="global-calc">
          <div class="global-calc-header">
            <div class="global-calc-label">
              <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
              사주 계산기
            </div>
            <div class="global-calc-center-label" id="calc-person-label">
              <input type="text" class="person-name-input" id="person1-name" value="본인" placeholder="이름 입력">
            </div>
            <div style="min-width:120px"></div>
          </div>
          
          <div class="global-calc-body" id="global-calc-body">
            <div class="form-row">
              <!-- 생년월일 입력 -->
              <div class="calc-section">
                <div class="calc-section-label">📅 생년월일</div>
                <div style="display:flex;gap:6px;align-items:flex-end;">
                  <div class="input-group">
                    <div class="stepper">
                      <button class="step-btn step-up" tabindex="-1" onclick="step('year',1)">
                        <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                      </button>
                      <input type="number" id="in-year" tabindex="1" placeholder="2000" min="1900" max="2100">
                      <button class="step-btn step-down" tabindex="-1" onclick="step('year',-1)">
                        <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                      </button>
                    </div>
                    <label>년</label>
                  </div>
                  <div class="input-group">
                    <div class="stepper">
                      <button class="step-btn step-up" tabindex="-1" onclick="step('month',1)">
                        <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                      </button>
                      <input type="number" id="in-month" tabindex="2" placeholder="01" min="1" max="12">
                      <button class="step-btn step-down" tabindex="-1" onclick="step('month',-1)">
                        <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                      </button>
                    </div>
                    <label>월</label>
                  </div>
                  <div class="input-group">
                    <div class="stepper">
                      <button class="step-btn step-up" tabindex="-1" onclick="step('day',1)">
                        <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                      </button>
                      <input type="number" id="in-day" tabindex="3" placeholder="01" min="1" max="31">
                      <button class="step-btn step-down" tabindex="-1" onclick="step('day',-1)">
                        <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                      </button>
                    </div>
                    <label>일</label>
                  </div>
                </div>
              </div>
              
              <div class="calc-divider"></div>
              
              <!-- 출생시간 입력 -->
              <div class="calc-section">
                <div class="calc-section-label">⏰ 출생시간</div>
                <div style="display:flex;gap:6px;align-items:flex-end;">
                  <div class="input-group">
                    <div class="stepper">
                      <button class="step-btn step-up" tabindex="-1" onclick="step('hour',1)">
                        <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                      </button>
                      <input type="number" id="in-hour" tabindex="4" placeholder="12" min="0" max="23">
                      <button class="step-btn step-down" tabindex="-1" onclick="step('hour',-1)">
                        <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                      </button>
                    </div>
                    <label>시</label>
                  </div>
                  <div class="input-group">
                    <div class="stepper">
                      <button class="step-btn step-up" tabindex="-1" onclick="step('min',1)">
                        <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                      </button>
                      <input type="number" id="in-min" tabindex="5" placeholder="00" min="0" max="59">
                      <button class="step-btn step-down" tabindex="-1" onclick="step('min',-1)">
                        <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                      </button>
                    </div>
                    <label>분</label>
                  </div>
                </div>
              </div>
              
              <div class="calc-divider"></div>
              
              <!-- 성별 선택 -->
              <div class="calc-section">
                <div class="calc-section-label">⚤ 성별</div>
                <div class="gender-toggle" id="gender-btns" role="radiogroup">
                  <button class="gender-btn active" data-gender="m" id="gender-m" onclick="setGender('m')">♂ 남</button>
                  <button class="gender-btn" data-gender="f" id="gender-f" onclick="setGender('f')">♀ 여</button>
                </div>
              </div>

            </div>
            
            <!-- 계산 버튼 -->
            <div class="calc-btn-row" id="main-calc-btns">
              <button class="btn-calc" id="btn-calculate" tabindex="6" onclick="onCalculate()">명식 계산 »</button>
              <button class="btn-calc btn-save-calc" id="btn-save-to-db" tabindex="7" onclick="onSaveToDb()">명식 저장</button>
            </div>
          </div>
        </section>

        <!-- ═══════════════════════════════════════════════════════════════════════════
             탭 패널들
             ═══════════════════════════════════════════════════════════════════════════ -->
        
        <!-- 오늘의 운세 탭 -->
        <div id="tab-today" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-today">
          <div id="today-empty" class="bti-empty">
            <div class="bti-empty-icon">☀️</div>
            <div class="bti-empty-title">오늘의 운세</div>
            <div class="bti-empty-desc">
              상단 사주 계산기에서 생년월일시를 입력하고<br>
              <b>계산</b>을 누르면 오늘의 운세가 표시됩니다.
            </div>
          </div>
          <div id="today-results" style="display:none"></div>
        </div>

        <!-- 사주BTI 탭 -->
        <div id="tab-bti" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-bti">
          <div id="bti-empty" class="bti-empty">
            <div class="bti-empty-icon"></div>
            <div class="bti-empty-title">사주BTI</div>
            <div class="bti-empty-desc">
              상단 사주 계산기에서 생년월일시를 입력하고<br>
              <b>계산</b>을 누르면 결과가 여기에 표시됩니다.
            </div>
          </div>
          <div id="bti-results" style="display:none"></div>
        </div>

        <!-- 전문 만세력 탭 -->
        <div id="tab-myeongshik" class="tab-panel active" role="tabpanel" aria-labelledby="tab-btn-myeongshik">
          <div id="myeongshik-empty" class="bti-empty">
            <div class="bti-empty-icon"></div>
            <div class="bti-empty-title">전문 만세력</div>
            <div class="bti-empty-desc">
              상단 사주 계산기에서 생년월일시를 입력하고<br>
              <b>계산</b>을 누르면 상세 명식이 표시됩니다.
            </div>
          </div>
          <div id="results" class="results-container" style="display:none">
            <div id="saju-pillars" class="result-section"></div>
            <div class="analysis-grid-new result-section">
              <div class="analysis-left-col">
                <div id="oheng-analysis"></div>
                <div id="yongsin-section"></div>
              </div>
              <div class="analysis-right-col">
                <div id="sipsung-analysis"></div>
              </div>
            </div>
            <div id="relations-section" class="result-section"></div>
            <div id="hidden-stems-section" class="result-section"></div>
            <div id="daeun-section" class="fortune-section result-section"></div>
            <div id="seun-section" class="fortune-section result-section"></div>
            <div id="wolun-section" class="fortune-section result-section"></div>
            <div id="fortune-interaction" class="fortune-section result-section"></div>
          </div>
        </div>

        <!-- 궁합 탭 -->
        <div id="tab-gunghap" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-gunghap">
          <!-- 본인↔상대 스와핑 버튼 -->
          <div class="gunghap-swap-row">
            <button class="btn-gunghap-swap" id="btn-gunghap-swap" title="본인과 상대 정보 교환">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
              본인 ↔ 상대 바꾸기
            </button>
          </div>
          <!-- 상대 정보 입력 (메인 계산기와 동일한 구조) -->
          <section class="global-calc gunghap-partner-calc" id="gunghap-person2">
            <div class="global-calc-header">
              <div class="global-calc-center-label">
                <input type="text" class="person-name-input" id="person2-name" value="상대" placeholder="이름 입력">
              </div>
              <div class="gunghap-person-actions gunghap-header-btns">
                <button class="btn-gunghap-celeb-gold" id="btn-gunghap-celeb" title="인물 DB에서 선택">⭐ 인물 찾기</button>
              </div>
            </div>

            <div class="global-calc-body" id="gunghap-person2-form">
              <div class="form-row">
                <!-- 생년월일 입력 -->
                <div class="calc-section">
                  <div class="calc-section-label">📅 생년월일</div>
                  <div style="display:flex;gap:6px;align-items:flex-end;">
                    <div class="input-group">
                      <div class="stepper">
                        <button class="step-btn step-up" tabindex="-1" onclick="stepGunghap('year',1)">
                          <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                        </button>
                        <input type="number" id="gh-year" placeholder="2000" min="1900" max="2100">
                        <button class="step-btn step-down" tabindex="-1" onclick="stepGunghap('year',-1)">
                          <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                        </button>
                      </div>
                      <label>년</label>
                    </div>
                    <div class="input-group">
                      <div class="stepper">
                        <button class="step-btn step-up" tabindex="-1" onclick="stepGunghap('month',1)">
                          <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                        </button>
                        <input type="number" id="gh-month" placeholder="01" min="1" max="12">
                        <button class="step-btn step-down" tabindex="-1" onclick="stepGunghap('month',-1)">
                          <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                        </button>
                      </div>
                      <label>월</label>
                    </div>
                    <div class="input-group">
                      <div class="stepper">
                        <button class="step-btn step-up" tabindex="-1" onclick="stepGunghap('day',1)">
                          <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                        </button>
                        <input type="number" id="gh-day" placeholder="01" min="1" max="31">
                        <button class="step-btn step-down" tabindex="-1" onclick="stepGunghap('day',-1)">
                          <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                        </button>
                      </div>
                      <label>일</label>
                    </div>
                  </div>
                </div>

                <div class="calc-divider"></div>

                <!-- 출생시간 입력 -->
                <div class="calc-section">
                  <div class="calc-section-label">⏰ 출생시간</div>
                  <div style="display:flex;gap:6px;align-items:flex-end;">
                    <div class="input-group">
                      <div class="stepper">
                        <button class="step-btn step-up" tabindex="-1" onclick="stepGunghap('hour',1)">
                          <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                        </button>
                        <input type="number" id="gh-hour" placeholder="12" min="0" max="23">
                        <button class="step-btn step-down" tabindex="-1" onclick="stepGunghap('hour',-1)">
                          <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                        </button>
                      </div>
                      <label>시</label>
                    </div>
                    <div class="input-group">
                      <div class="stepper">
                        <button class="step-btn step-up" tabindex="-1" onclick="stepGunghap('min',1)">
                          <svg viewBox="0 0 14 8"><path d="M1,7 L7,1.5 L13,7"/></svg>
                        </button>
                        <input type="number" id="gh-min" placeholder="00" min="0" max="59">
                        <button class="step-btn step-down" tabindex="-1" onclick="stepGunghap('min',-1)">
                          <svg viewBox="0 0 14 8"><path d="M1,1 L7,6.5 L13,1"/></svg>
                        </button>
                      </div>
                      <label>분</label>
                    </div>
                  </div>
                </div>

                <div class="calc-divider"></div>

                <!-- 성별 선택 -->
                <div class="calc-section">
                  <div class="calc-section-label">⚤ 성별</div>
                  <div class="gender-toggle" id="gh-gender-btns" role="radiogroup">
                    <button class="gender-btn gh-gender-btn active" data-gender="m" id="gh-gender-m" onclick="setGunghapGender('m')">♂ 남</button>
                    <button class="gender-btn gh-gender-btn" data-gender="f" id="gh-gender-f" onclick="setGunghapGender('f')">♀ 여</button>
                  </div>
                </div>

              </div>

              <!-- 궁합 분석 버튼 -->
              <div class="calc-btn-row gunghap-btn-row">
                <button class="btn-calc btn-gunghap-calc" id="btn-gunghap-calc" disabled>궁합 분석하기</button>
                <button class="btn-calc btn-gunghap-best" id="btn-gunghap-best" title="최고의 궁합 보기">최고의 궁합 보기</button>
              </div>
            </div>
          </section>

          <div id="gunghap-results" style="display:none"></div>

          <div class="gunghap-share" id="gunghap-share" style="display:none">
            <button class="btn-share btn-share-link" id="btn-share-gunghap-link">🔗 링크 복사</button>
            <button class="btn-share btn-share-kakao" id="btn-share-gunghap-kakao">💬 공유하기</button>
          </div>
        </div>

        <!-- 유명인 DB 탭 -->
        <div id="tab-celeb" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-celeb">
          <!-- 인물위키 안내 -->
          <div class="wiki-notice">
            <p><b>📚 인물위키</b> — 유명인의 사주 정보를 모아놓은 위키입니다.</p>
            <p class="wiki-notice-sub">• 모든 생년월일은 <b>양력(한국 시간)</b> 기준입니다. 음력·해외 출생은 양력 변환 및 시차 보정된 값입니다.<br>• 나이는 <b>세는 나이</b>로 표시됩니다.<br>• <b>미성년자</b>의 명식 조회는 가능하나, 인물로 등록할 수는 없습니다.</p>
          </div>
          <div class="db-controls">
            <div class="db-search-wrapper">
              <input type="text" id="db-search" placeholder="이름, 직업으로 검색..." aria-label="유명인 검색">
              <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="M21 21l-4.35-4.35"></path>
              </svg>
            </div>

            <div class="db-type-toggle" id="db-type-toggle" role="radiogroup" aria-label="데이터베이스 선택">
              <button class="db-type-btn active" data-type="celebrity" role="radio" aria-checked="true">
                ⭐ 유명인
              </button>
              <button class="db-type-btn" data-type="personal" role="radio" aria-checked="false">
                📁 개인
              </button>
            </div>

            <button class="btn-add-person-header" id="btn-add-person" title="새 인물 추가">
              ➕ 인물 추가
            </button>

            <div class="db-actions" id="db-actions" style="display:none">
              <button class="btn-db-action" id="btn-db-login" title="로그인" style="display:none">
                <span>🔐</span> 로그인
              </button>
            </div>
          </div>

          <!-- 개인 DB 로그인 안내 -->
          <div class="db-login-notice" id="db-login-notice" style="display:none">
            <div class="db-login-box">
              <div class="db-login-title">🔐 개인 DB 로그인</div>
              <p>개인 DB는 로그인한 사용자만 조회/추가/삭제할 수 있습니다.</p>
              <div class="db-login-form">
                <input type="text" id="db-username" placeholder="아이디" class="db-login-input">
                <input type="password" id="db-password" placeholder="비밀번호" class="db-login-input">
                <button class="btn-db-login-submit" id="btn-db-login-submit">로그인</button>
              </div>
              <div class="db-login-info">
                <small>* 유명인 DB는 누구나 열람 가능합니다</small>
              </div>
            </div>
          </div>
          
          <div class="db-stats" id="db-stats">
            <span class="db-count">총 <strong id="db-total-count">0</strong>명</span>
            <span class="db-filtered" id="db-filtered-info"></span>
          </div>

          <!-- 정렬/필터 -->
          <div class="db-sort-section">
            <div class="db-sort-row">
              <div class="db-sort-wrap" id="db-sort-wrap"></div>
            </div>
            <div class="db-filter-rows" id="db-filter-rows"></div>
            <div class="db-sort-active" id="db-sort-active"></div>
          </div>

          <div class="db-list" id="db-list">
            <!-- 동적으로 생성됨 -->
          </div>
          
          <div class="db-pagination" id="db-pagination">
            <!-- 동적으로 생성됨 -->
          </div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════════
             방명록 탭
             ═══════════════════════════════════════════════════════════════════════════ -->
        <div id="tab-guestbook" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-guestbook">
          <div class="section-header">
            <h2>📝 피드백 수납</h2>
            <p class="section-desc">모든 피드백은 익명으로 처리됩니다.</p>
          </div>

          <div class="guestbook-chat-container" id="guestbook-container">
            <!-- 메시지 목록 -->
            <div class="guestbook-messages" id="guestbook-messages">
              <!-- 동적으로 생성됨 -->
            </div>

            <!-- 입력 영역 -->
            <div class="guestbook-input-area">
              <!-- 닉네임/비밀번호 -->
              <div class="guestbook-input-row gb-meta-row">
                <input type="text" id="gb-nickname" class="gb-input gb-nickname" placeholder="닉네임" maxlength="20">
                <input type="password" id="gb-password" class="gb-input gb-password" placeholder="비밀번호 (삭제 시 필요)" maxlength="20">
              </div>
              <!-- 메시지 입력 -->
              <div class="guestbook-input-row">
                <input type="text" id="gb-message" class="gb-input gb-message" placeholder="피드백을 남겨주세요 (200자 이내)" maxlength="200">
                <button class="gb-send-btn" id="gb-send-btn" title="전송">
                  <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
              </div>
              <div class="guestbook-char-count"><span id="gb-char-count">0</span>/200</div>
            </div>
          </div>
        </div>

        <!-- ═══ 최근 변경 탭 ═══ -->
        <div id="tab-recent" class="tab-panel" role="tabpanel">
          <div class="section-header">
            <h2>최근 변경</h2>
            <p class="section-desc">인물위키에 최근 추가된 인물 목록입니다.</p>
          </div>
          <div id="recent-changes-full-list" class="recent-changes-full-list">
            <!-- 동적으로 생성됨 -->
          </div>
        </div>

      </div><!-- .main-content -->
    </div><!-- .main-layout -->

  </div><!-- .container -->

  <!-- ═══════════════════════════════════════════════════════════════════════════
       사이드바
       ═══════════════════════════════════════════════════════════════════════════ -->
  <aside class="sidebar" id="sidebar">
    <!-- 지금의 사주 카드 -->
    <div class="sidebar-card" id="sidebar-today-saju">
      <div class="sidebar-header">
        <h3>지금의 사주</h3>
      </div>
      <div class="sidebar-body" id="sidebar-today-saju-content">
        <!-- 동적으로 생성됨 -->
      </div>
    </div>

    <!-- 오늘의 운세 카드 (사주 계산 후 표시) -->
    <div class="sidebar-card" id="sidebar-today-fortune" style="display:none">
      <div class="sidebar-header">
        <h3>오늘의 운세</h3>
      </div>
      <div class="sidebar-body" id="sidebar-today-fortune-content">
        <!-- 동적으로 생성됨 -->
      </div>
    </div>

    <!-- 최근 변경 카드 -->
    <div class="sidebar-card" id="sidebar-recent-changes">
      <div class="sidebar-header" style="cursor:pointer" onclick="switchTab('recent')">
        <h3>최근 변경</h3>
        <span style="font-size:0.7rem;color:var(--text-dim)">전체 보기 &rsaquo;</span>
      </div>
      <div class="sidebar-body" id="sidebar-recent-changes-content">
        <div class="recent-changes-list" id="recent-changes-list">
          <!-- 동적으로 생성됨 -->
        </div>
      </div>
    </div>
  </aside>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       푸터
       ═══════════════════════════════════════════════════════════════════════════ -->
  <footer id="app-footer" class="app-footer">
    <!-- FooterRenderer.render()로 동적 생성됨 -->
  </footer>

  </div><!-- .page-wrapper -->

  <!-- ═══════════════════════════════════════════════════════════════════════════
       알림 컨테이너
       ═══════════════════════════════════════════════════════════════════════════ -->
  <div id="notification-container" class="notification-container" aria-live="polite"></div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       모달 컨테이너
       ═══════════════════════════════════════════════════════════════════════════ -->
  <div id="modal-container">
    <!-- 로그인 모달 -->
    <div class="modal" id="modal-login" role="dialog" aria-modal="true" aria-labelledby="modal-login-title">
      <div class="modal-backdrop" onclick="window.__hideLoginModal()"></div>
      <div class="modal-content modal-login-content">
        <div class="modal-header">
          <h3 id="modal-login-title">로그인</h3>
          <button class="modal-close" onclick="window.__hideLoginModal && window.__hideLoginModal()" aria-label="닫기">&times;</button>
        </div>
        <div class="modal-body">
          <p class="login-desc">Google 계정으로 간편하게 로그인하세요.<br>로그인하면 사주 저장, 인물 추가, 방명록 작성이 가능합니다.</p>
          <div class="login-buttons">
            <button class="btn-social btn-google" onclick="window.__loginWith && window.__loginWith('google')">
              <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              Google로 로그인
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 닉네임 설정 모달 -->
    <div class="modal" id="modal-nickname" role="dialog" aria-modal="true">
      <div class="modal-backdrop" onclick="window.__hideNicknameModal && window.__hideNicknameModal()"></div>
      <div class="modal-content modal-login-content">
        <div class="modal-header">
          <h3>닉네임 설정</h3>
          <button class="modal-close" onclick="window.__hideNicknameModal && window.__hideNicknameModal()" aria-label="닫기">&times;</button>
        </div>
        <div class="modal-body">
          <p class="login-desc">인물위키 기여 시 표시될 닉네임을 설정하세요.</p>
          <div style="margin-bottom:12px">
            <input type="text" id="nickname-input" maxlength="16" placeholder="닉네임 (2~16자)" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:0.95rem;box-sizing:border-box">
            <small id="nickname-error" style="color:#c0392b;font-size:0.75rem;margin-top:4px;display:none"></small>
            <small style="color:#888;font-size:0.72rem;margin-top:4px;display:block">한글, 영문, 숫자, 언더바(_)만 사용 가능</small>
          </div>
          <button id="nickname-save-btn" style="width:100%;padding:12px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:0.95rem;font-weight:600;cursor:pointer">저장</button>
        </div>
      </div>
    </div>

    <!-- 인물 추가/편집 모달 -->
    <div class="modal" id="modal-person-edit" role="dialog" aria-modal="true" aria-labelledby="modal-person-title">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modal-person-title">인물 추가</h3>
          <button class="modal-close" aria-label="닫기">&times;</button>
        </div>
        <div class="modal-body" id="modal-person-body">
          <!-- 동적으로 생성됨 -->
        </div>
        <div class="modal-footer">
          <button class="btn-cancel">취소</button>
          <button class="btn-confirm">저장</button>
        </div>
      </div>
    </div>
    
    <!-- 확인 모달 -->
    <div class="modal" id="modal-confirm" role="alertdialog" aria-modal="true" aria-labelledby="modal-confirm-title">
      <div class="modal-backdrop"></div>
      <div class="modal-content modal-sm">
        <div class="modal-header">
          <h3 id="modal-confirm-title">확인</h3>
        </div>
        <div class="modal-body" id="modal-confirm-body">
          <!-- 동적으로 생성됨 -->
        </div>
        <div class="modal-footer">
          <button class="btn-cancel">취소</button>
          <button class="btn-confirm btn-danger">확인</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       글로벌 UI 함수 (모듈과 연동)
       ═══════════════════════════════════════════════════════════════════════════ -->
  <script>
    // 입력값 정규화용 헬퍼
    function daysInMonth(y,m){return new Date(y,m,0).getDate();}
    function getInputs(){
      return {
        year:parseInt(document.getElementById('in-year').value)||0,
        month:parseInt(document.getElementById('in-month').value)||0,
        day:parseInt(document.getElementById('in-day').value)||0,
        hour:parseInt(document.getElementById('in-hour').value)||0,
        min:parseInt(document.getElementById('in-min').value)||0
      };
    }
    function setInputs(v){
      document.getElementById('in-year').value=v.year||'';
      document.getElementById('in-month').value=v.month?String(v.month).padStart(2,'0'):'';
      document.getElementById('in-day').value=v.day?String(v.day).padStart(2,'0'):'';
      document.getElementById('in-hour').value=v.hour!==undefined?String(v.hour).padStart(2,'0'):'';
      document.getElementById('in-min').value=v.min!==undefined?String(v.min).padStart(2,'0'):'';
    }
    function normalize(v){
      while(v.min>59){v.min-=60;v.hour++;}
      while(v.min<0){v.min+=60;v.hour--;}
      while(v.hour>23){v.hour-=24;v.day++;}
      while(v.hour<0){v.hour+=24;v.day--;}
      while(v.month>12){v.month-=12;v.year++;}
      while(v.month<1){v.month+=12;v.year--;}
      let mx=daysInMonth(v.year,v.month);
      while(v.day>mx){v.day-=mx;v.month++;if(v.month>12){v.month=1;v.year++;}mx=daysInMonth(v.year,v.month);}
      while(v.day<1){v.month--;if(v.month<1){v.month=12;v.year--;}v.day+=daysInMonth(v.year,v.month);}
      v.year=Math.max(1900,Math.min(2100,v.year));
      return v;
    }

    // 스텝퍼 함수
    function step(field,delta){
      const v=getInputs();
      if(!v.year&&!v.month&&!v.day)return;
      v[field]=(v[field]||0)+delta;
      normalize(v);
      setInputs(v);
    }

    // 성별 설정
    let selectedGender='m';
    function setGender(g){
      selectedGender=g;
      document.getElementById('gender-m').classList.toggle('active',g==='m');
      document.getElementById('gender-f').classList.toggle('active',g==='f');
    }

    // 탭 전환
    function switchTab(name){
      document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      const panel=document.getElementById('tab-'+name);
      const btn=document.querySelector('.tab-btn[data-tab="'+name+'"]');
      if(panel)panel.classList.add('active');
      if(btn)btn.classList.add('active');
      // 유명인 DB 탭과 방명록 탭에서만 글로벌 계산기 숨기기
      const gc=document.getElementById('global-calc');
      if(gc)gc.style.display=(name==='celeb'||name==='guestbook'||name==='recent')?'none':'';
      // 탭별 헤더 표시/숨기기
      const btiHeader=document.getElementById('bti-top-header');
      const msHeader=document.getElementById('myeongshik-top-header');
      const ghHeader=document.getElementById('gunghap-top-header');
      if(btiHeader)btiHeader.style.display=(name==='bti')?'':'none';
      if(msHeader)msHeader.style.display=(name==='myeongshik')?'':'none';
      if(ghHeader)ghHeader.style.display=(name==='gunghap')?'':'none';
      // 궁합 탭에서는 계산 버튼 숨기기 (본인 사주만 입력)
      const calcBtns=document.getElementById('main-calc-btns');
      if(calcBtns)calcBtns.style.display=(name==='gunghap'||name==='recent')?'none':'';
      // 최근 변경 탭 진입 시 갱신
      if(name==='recent' && window.__refreshRecentChanges) window.__refreshRecentChanges();
      // 궁합 탭에서 본인 레이블 변경
      const personNameInput=document.getElementById('person1-name');
      if(personNameInput)personNameInput.value='본인';
    }

    // 계산 실행 (모듈의 app 인스턴스 사용)
    function onCalculate(){
      const y=parseInt(document.getElementById('in-year').value);
      const m=parseInt(document.getElementById('in-month').value);
      const d=parseInt(document.getElementById('in-day').value);
      const rawH=document.getElementById('in-hour').value.trim();
      const rawM=document.getElementById('in-min').value.trim();

      if(!y||!m||!d){
        alert('년, 월, 일을 입력해주세요.');
        return;
      }

      const hasTime=rawH!=='';
      const h=hasTime?(parseInt(rawH)||0):12;
      const mi=parseInt(rawM)||0;

      // 모듈의 appState에 계산 이벤트 발행
      if(window.__sajuState){
        window.__sajuState.emit('calculate', {
          year:y, month:m, day:d,
          hour:hasTime?h:null,
          minute:mi,
          gender:selectedGender,
          hasTime:hasTime
        });
      } else {
        console.error('앱이 아직 초기화되지 않았습니다. 잠시 후 다시 시도해주세요.');
      }
    }

    // DB 저장 함수
    function onSaveToDb(){
      // 로그인 체크 (새로운 인증 시스템 사용)
      const user = window.__getCurrentUser ? window.__getCurrentUser() : null;
      if(!user){
        if(window.__showLoginModal) {
          window.__showLoginModal();
        } else {
          alert('로그인이 필요합니다.');
        }
        return;
      }

      const y=parseInt(document.getElementById('in-year').value);
      const m=parseInt(document.getElementById('in-month').value);
      const d=parseInt(document.getElementById('in-day').value);
      const rawH=document.getElementById('in-hour').value.trim();
      const rawM=document.getElementById('in-min').value.trim();

      if(!y||!m||!d){
        alert('생년월일을 먼저 입력해주세요.');
        return;
      }

      const name = prompt('저장할 이름을 입력하세요:');
      if(!name || !name.trim()) return;

      const hasTime=rawH!=='';
      const h=hasTime?(parseInt(rawH)||0):null;
      const mi=parseInt(rawM)||0;

      // dbManager를 통해 저장
      if(window.__sajuDbManager) {
        const result = window.__sajuDbManager.addPerson({
          name: name.trim(),
          year: y,
          month: m,
          day: d,
          hour: h,
          min: mi,
          gender: selectedGender,
          note: ''
        }, 'personal');
        if(result.success) {
          alert('명식이 저장되었습니다.');
          // 유명인 DB 탭 갱신
          if(window.__sajuApp && window.__sajuApp.celebPicker) {
            window.__sajuApp.celebPicker._renderList();
          }
        } else {
          alert(result.message || '저장 실패');
        }
      } else {
        alert('앱이 아직 초기화되지 않았습니다.');
      }
    }


    // ═══ 궁합 계산기 함수들 ═══
    let gunghapGender='m';
    function getGunghapInputs(){
      return {
        year:parseInt(document.getElementById('gh-year').value)||0,
        month:parseInt(document.getElementById('gh-month').value)||0,
        day:parseInt(document.getElementById('gh-day').value)||0,
        hour:parseInt(document.getElementById('gh-hour').value)||0,
        min:parseInt(document.getElementById('gh-min').value)||0
      };
    }
    function setGunghapInputs(v){
      document.getElementById('gh-year').value=v.year||'';
      document.getElementById('gh-month').value=v.month?String(v.month).padStart(2,'0'):'';
      document.getElementById('gh-day').value=v.day?String(v.day).padStart(2,'0'):'';
      document.getElementById('gh-hour').value=v.hour!==undefined?String(v.hour).padStart(2,'0'):'';
      document.getElementById('gh-min').value=v.min!==undefined?String(v.min).padStart(2,'0'):'';
    }
    function stepGunghap(field,delta){
      const v=getGunghapInputs();
      if(!v.year&&!v.month&&!v.day)return;
      v[field]=(v[field]||0)+delta;
      normalize(v);
      setGunghapInputs(v);
      updateGunghapButton();
    }
    function setGunghapGender(g){
      gunghapGender=g;
      document.getElementById('gh-gender-m').classList.toggle('active',g==='m');
      document.getElementById('gh-gender-f').classList.toggle('active',g==='f');
    }
    function updateGunghapButton(){
      const v=getGunghapInputs();
      const btn=document.getElementById('btn-gunghap-calc');
      if(btn) btn.disabled=!(v.year&&v.month&&v.day);
    }

    // 본인↔상대 스와핑
    document.addEventListener('DOMContentLoaded', () => {
      const swapBtn = document.getElementById('btn-gunghap-swap');
      if (swapBtn) {
        swapBtn.addEventListener('click', () => {
          // 본인 입력값
          const p1y = document.getElementById('in-year');
          const p1m = document.getElementById('in-month');
          const p1d = document.getElementById('in-day');
          const p1h = document.getElementById('in-hour');
          const p1mi = document.getElementById('in-min');
          const p1name = document.getElementById('person1-name');
          const p1gm = document.getElementById('gender-m');
          const p1gf = document.getElementById('gender-f');
          // 상대 입력값
          const p2y = document.getElementById('gh-year');
          const p2m = document.getElementById('gh-month');
          const p2d = document.getElementById('gh-day');
          const p2h = document.getElementById('gh-hour');
          const p2mi = document.getElementById('gh-min');
          const p2name = document.getElementById('person2-name');
          const p2gm = document.getElementById('gh-gender-m');
          const p2gf = document.getElementById('gh-gender-f');

          // 값 임시 저장
          const tmp = {
            y: p1y?.value, m: p1m?.value, d: p1d?.value, h: p1h?.value, mi: p1mi?.value,
            name: p1name?.value,
            genderM: p1gm?.classList.contains('active')
          };

          // 본인 ← 상대
          if(p1y) p1y.value = p2y?.value || '';
          if(p1m) p1m.value = p2m?.value || '';
          if(p1d) p1d.value = p2d?.value || '';
          if(p1h) p1h.value = p2h?.value || '';
          if(p1mi) p1mi.value = p2mi?.value || '';
          if(p1name) p1name.value = p2name?.value || '본인';
          const p2WasM = p2gm?.classList.contains('active');
          if(typeof setGender === 'function') setGender(p2WasM ? 'm' : 'f');

          // 상대 ← 본인
          if(p2y) p2y.value = tmp.y || '';
          if(p2m) p2m.value = tmp.m || '';
          if(p2d) p2d.value = tmp.d || '';
          if(p2h) p2h.value = tmp.h || '';
          if(p2mi) p2mi.value = tmp.mi || '';
          if(p2name) p2name.value = tmp.name || '상대';
          if(typeof setGunghapGender === 'function') setGunghapGender(tmp.genderM ? 'm' : 'f');

          updateGunghapButton();
        });
      }
    });

    // 자동 다음 칸 이동 (본인 입력)
    function setupAutoAdvance(){
      const fields=[
        {id:'in-year',max:4,next:'in-month'},
        {id:'in-month',max:2,next:'in-day'},
        {id:'in-day',max:2,next:'in-hour'},
        {id:'in-hour',max:2,next:'in-min'},
        {id:'gh-year',max:4,next:'gh-month'},
        {id:'gh-month',max:2,next:'gh-day'},
        {id:'gh-day',max:2,next:'gh-hour'},
        {id:'gh-hour',max:2,next:'gh-min'}
      ];
      fields.forEach(f=>{
        const el=document.getElementById(f.id);
        if(el){
          el.addEventListener('input',()=>{
            if(el.value.length>=f.max){
              const next=document.getElementById(f.next);
              if(next){next.focus();next.select();}
            }
            updateGunghapButton();
          });
        }
      });
    }
    document.addEventListener('DOMContentLoaded',setupAutoAdvance);

    // ═══ 피드백 수납 기능 (Firestore 연동, 익명) ═══
    const guestbookManager = {
      messages: [],
      db: null,

      async init() {
        await this.initFirestore();
        await this.loadMessages();
        this.render();
        this.setupEvents();
      },

      async initFirestore() {
        try {
          if (typeof firebase === 'undefined') {
            console.error('[피드백] Firebase SDK 미로드');
            return;
          }
          if (firebase.apps.length === 0) {
            firebase.initializeApp({
              apiKey: "AIzaSyCT35ZUVMKM8V1Duc7cydUmIBk0T_OH-zE",
              authDomain: "saju-wiki.firebaseapp.com",
              projectId: "saju-wiki",
              storageBucket: "saju-wiki.firebasestorage.app",
              messagingSenderId: "846763046239",
              appId: "1:846763046239:web:4d0a7a5b3e50ce046172ea"
            });
          }
          this.db = firebase.firestore();
          console.log('[피드백] Firestore 연결 완료');

          // 익명 인증 (보안 규칙 통과용)
          try {
            if (!firebase.auth().currentUser) {
              await firebase.auth().signInAnonymously();
            }
            console.log('[피드백] 인증 완료:', firebase.auth().currentUser?.uid);
          } catch (authErr) {
            console.warn('[피드백] 익명 인증 실패 (규칙이 공개면 무관):', authErr.code);
          }
        } catch (e) {
          console.error('[피드백] Firestore 초기화 실패:', e);
          this.db = null;
        }
      },

      hashPassword(str) {
        let hash = 5381;
        for (let i = 0; i < str.length; i++) {
          hash = ((hash << 5) + hash) + str.charCodeAt(i);
          hash = hash & hash;
        }
        return hash.toString(36);
      },

      async loadMessages() {
        console.log('[피드백] loadMessages 시작, db:', !!this.db);
        if (this.db) {
          try {
            const snapshot = await this.db.collection('guestbook').get();
            console.log('[피드백] Firestore 문서 수:', snapshot.size);
            this.messages = snapshot.docs.map(doc => {
              const d = doc.data();
              return {
                id: doc.id,
                nickname: d.nickname || '익명',
                passwordHash: d.passwordHash || '',
                text: d.content || d.text || '',
                timestamp: d.createdAt?.toDate?.()?.getTime() || Date.now()
              };
            });
            this.messages.sort((a, b) => a.timestamp - b.timestamp);
            console.log('[피드백] 로드 완료:', this.messages.length, '개');
            return;
          } catch (e) {
            console.error('[피드백] Firestore 로드 실패:', e.code, e.message);
          }
        } else {
          console.warn('[피드백] Firestore 미연결, localStorage 폴백');
        }
        const stored = localStorage.getItem('yonsei_guestbook');
        this.messages = stored ? JSON.parse(stored) : [];
      },

      render() {
        const container = document.getElementById('guestbook-messages');
        if (!container) return;
        if (this.messages.length === 0) {
          container.innerHTML = '<div class="guestbook-empty"><div class="guestbook-empty-icon">💬</div><p>아직 피드백이 없습니다.<br>첫 번째 피드백을 남겨보세요!</p></div>';
          return;
        }
        container.innerHTML = this.messages.map((m, i) => {
          const initial = (m.nickname || '?').charAt(0).toUpperCase();
          const date = new Date(m.timestamp);
          const time = `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
          const isAdmin = window.__isAdmin && window.__isAdmin();
          return `<div class="gb-message-item">
            <div class="gb-avatar">${initial}</div>
            <div class="gb-bubble">
              <div class="gb-bubble-header">
                <span class="gb-nickname">${this.escapeHtml(m.nickname)}</span>
                <span class="gb-time">${time}</span>
                ${isAdmin ? `<button class="gb-delete-btn" data-idx="${i}" title="삭제">🗑️</button>` : ''}
              </div>
              <div class="gb-text">${this.escapeHtml(m.text)}</div>
            </div>
          </div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
      },

      escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },

      async addMessage(nickname, password, text) {
        const passwordHash = this.hashPassword(password);
        const timestamp = Date.now();

        if (this.db) {
          try {
            const docRef = await this.db.collection('guestbook').add({
              nickname,
              passwordHash,
              content: text,
              createdAt: new Date(timestamp)
            });
            this.messages.push({ id: docRef.id, nickname, passwordHash, text, timestamp });
            this.render();
            return;
          } catch (e) {
            console.error('Firestore 저장 실패:', e.code, e.message);
            alert('피드백 저장 실패: ' + (e.code === 'permission-denied'
              ? 'Firestore 보안 규칙에서 guestbook 컬렉션의 쓰기를 허용해주세요.'
              : e.message));
            return;
          }
        }
        this.messages.push({ id: timestamp.toString(), nickname, passwordHash, text, timestamp });
        localStorage.setItem('yonsei_guestbook', JSON.stringify(this.messages));
        this.render();
      },

      async deleteMessage(idx) {
        const msg = this.messages[idx];
        if (!msg) return false;
        if (!window.__isAdmin || !window.__isAdmin()) {
          alert('관리자만 삭제할 수 있습니다.');
          return false;
        }
        if (!confirm('이 피드백을 삭제하시겠습니까?')) return false;

        if (this.db && msg.id) {
          try {
            await this.db.collection('guestbook').doc(msg.id).delete();
          } catch (e) {
            console.warn('Firestore 삭제 실패:', e);
          }
        }
        this.messages.splice(idx, 1);
        if (!this.db) {
          localStorage.setItem('yonsei_guestbook', JSON.stringify(this.messages));
        }
        this.render();
        return true;
      },

      setupEvents() {
        const msgInput = document.getElementById('gb-message');
        const charCount = document.getElementById('gb-char-count');
        const sendBtn = document.getElementById('gb-send-btn');

        if (msgInput && charCount) {
          msgInput.addEventListener('input', () => {
            charCount.textContent = msgInput.value.length;
          });
          msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.send();
          });
        }
        if (sendBtn) {
          sendBtn.addEventListener('click', () => this.send());
        }

        const container = document.getElementById('guestbook-messages');
        if (container) {
          container.addEventListener('click', (e) => {
            const btn = e.target.closest('.gb-delete-btn');
            if (btn) {
              const idx = parseInt(btn.dataset.idx);
              this.deleteMessage(idx);
            }
          });
        }
      },

      async send() {
        const nickname = document.getElementById('gb-nickname')?.value.trim();
        const password = document.getElementById('gb-password')?.value;
        const text = document.getElementById('gb-message')?.value.trim();
        if (!nickname) { alert('닉네임을 입력하세요.'); return; }
        if (!password) { alert('비밀번호를 입력하세요.'); return; }
        if (!text) { alert('메시지를 입력하세요.'); return; }
        if (text.length > 200) { alert('메시지는 200자 이내로 작성해주세요.'); return; }
        await this.addMessage(nickname, password, text);
        document.getElementById('gb-message').value = '';
        document.getElementById('gb-char-count').textContent = '0';
      }
    };
    document.addEventListener('DOMContentLoaded', () => guestbookManager.init());

    // ═══ 최근 변경 기능 ═══
    const recentChangesManager = {
      escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      },

      getRecentPersons() {
        const dbManager = window.__sajuDbManager;
        if (!dbManager) return [];
        const personal = dbManager.getAll('personal') || [];
        // contributor.addedAt 기준 정렬 (최신 먼저)
        return personal
          .filter(p => p.contributor && p.contributor.addedAt)
          .sort((a, b) => new Date(b.contributor.addedAt) - new Date(a.contributor.addedAt));
      },

      formatDate(dateStr) {
        const d = new Date(dateStr);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return '방금 전';
        if (diff < 3600000) return Math.floor(diff / 60000) + '분 전';
        if (diff < 86400000) return Math.floor(diff / 3600000) + '시간 전';
        if (diff < 604800000) return Math.floor(diff / 86400000) + '일 전';
        return `${d.getMonth() + 1}/${d.getDate()}`;
      },

      renderSidebar() {
        const container = document.getElementById('recent-changes-list');
        if (!container) return;
        const persons = this.getRecentPersons().slice(0, 10);
        if (persons.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:#999;font-size:0.8rem;padding:12px 0">아직 추가된 인물이 없습니다.</div>';
          return;
        }
        container.innerHTML = persons.map(p => {
          const cName = this.escapeHtml(p.contributor?.nickname || p.contributor?.name || '익명');
          const date = this.formatDate(p.contributor.addedAt);
          return `<div class="recent-change-item" onclick="switchTab('celeb')">
            <span class="recent-change-badge new">NEW</span>
            <span class="recent-change-name">${this.escapeHtml(p.name)}</span>
            <span class="recent-change-note">${cName}</span>
            <span class="recent-change-date">${date}</span>
          </div>`;
        }).join('');
      },

      renderFullList() {
        const container = document.getElementById('recent-changes-full-list');
        if (!container) return;
        const persons = this.getRecentPersons();
        if (persons.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:#999;padding:40px 20px">아직 추가된 인물이 없습니다.</div>';
          return;
        }
        container.innerHTML = persons.map(p => {
          const cName = this.escapeHtml(p.contributor?.nickname || p.contributor?.name || '익명');
          const date = this.formatDate(p.contributor.addedAt);
          const genderText = p.gender === 'm' ? '남' : p.gender === 'f' ? '여' : '';
          const dateStr = `${p.year}년 ${p.month}월 ${p.day}일` + (p.hour !== '' && p.hour !== undefined ? ` ${p.hour}시` : '');
          return `<div class="recent-change-full-item" onclick="switchTab('celeb')">
            <div class="rcf-header">
              <span class="recent-change-badge new">NEW</span>
              <span class="rcf-name">${this.escapeHtml(p.name)}</span>
              <span class="rcf-meta">${dateStr}${genderText ? ' · ' + genderText : ''}</span>
            </div>
            <div class="rcf-footer">
              <span class="rcf-contributor">기여자: ${cName}</span>
              ${p.note ? `<span class="rcf-note">${this.escapeHtml(p.note)}</span>` : ''}
              <span class="rcf-date">${date}</span>
            </div>
          </div>`;
        }).join('');
      },

      init() {
        // 초기 렌더 (DB 로드 후)
        setTimeout(() => {
          this.renderSidebar();
          this.renderFullList();
        }, 1000);
      }
    };
    document.addEventListener('DOMContentLoaded', () => recentChangesManager.init());
    // 전역 접근 (인물 추가 후 갱신용)
    window.__refreshRecentChanges = () => {
      recentChangesManager.renderSidebar();
      recentChangesManager.renderFullList();
    };

    // 사이드바 스크롤 추종 기능 비활성화 (사이드바가 이제 레이아웃의 일부)

    // ═══ 헤더 키워드 검색 기능 ═══
    const headerSearch = {
      keywords: [
        { title:'사주BTI', desc:'일간 기반 10가지 성격 유형 분석', tab:'bti' },
        { title:'전문 만세력', desc:'사주팔자 천간/지지 오행 분포 상세 분석', tab:'myeongshik' },
        { title:'궁합', desc:'두 사람의 사주 궁합 분석', tab:'gunghap' },
        { title:'인물위키', desc:'유명인 사주 정보 데이터베이스', tab:'celeb' },
        { title:'방명록', desc:'방문자 메시지 남기기', tab:'guestbook' },
        { title:'오행', desc:'목·화·토·금·수 오행 분석', tab:'myeongshik' },
        { title:'십성', desc:'비견·겁재·식신·상관·편재·정재·편관·정관·편인·정인', tab:'myeongshik' },
        { title:'대운', desc:'10년 단위 대운 흐름 분석', tab:'myeongshik' },
        { title:'세운', desc:'연도별 세운 분석', tab:'myeongshik' },
        { title:'월운', desc:'월별 운세 분석', tab:'myeongshik' },
        { title:'용신', desc:'사주의 균형을 맞추는 용신 분석', tab:'myeongshik' },
        { title:'천간', desc:'갑을병정무기경신임계 10천간', tab:'myeongshik' },
        { title:'지지', desc:'자축인묘진사오미신유술해 12지지', tab:'myeongshik' },
        { title:'12운성', desc:'장생·목욕·관대·건록·제왕·쇠·병·사·묘·절·태·양', tab:'myeongshik' },
        { title:'형충파해', desc:'지지 간 형·충·파·해·원진 관계', tab:'myeongshik' },
        { title:'일간', desc:'일간(나)을 기준으로 한 사주 해석', tab:'bti' },
        { title:'절기 달력', desc:'24절기 달력 보기', action:'jeolgi' },
        { title:'사주 개념 가이드', desc:'사주 입문자를 위한 개념 설명', action:'guide' },
        { title:'성격', desc:'사주BTI로 알아보는 나의 성격', tab:'bti' },
        { title:'MBTI', desc:'사주 기반 MBTI 유사 성격 분석', tab:'bti' },
        { title:'최고의 궁합', desc:'나와 가장 잘 맞는 궁합 조합 찾기', tab:'gunghap' },
      ],

      init() {
        const input = document.getElementById('header-search-input');
        const results = document.getElementById('header-search-results');
        if(!input || !results) return;

        input.addEventListener('input', () => {
          const q = input.value.trim().toLowerCase();
          if(!q) { results.classList.remove('active'); return; }
          const matched = this.keywords.filter(k =>
            k.title.toLowerCase().includes(q) || k.desc.toLowerCase().includes(q)
          );
          if(matched.length === 0) {
            results.innerHTML = '<div class="search-no-result">검색 결과가 없습니다</div>';
          } else {
            results.innerHTML = matched.map((item, i) =>
              `<div class="search-result-item" data-idx="${i}">
                <div class="search-result-title">${item.title}</div>
                <div class="search-result-desc">${item.desc}</div>
              </div>`
            ).join('');
            results.querySelectorAll('.search-result-item').forEach((el, i) => {
              el.addEventListener('click', () => {
                const item = matched[i];
                if(item.tab) { switchTab(item.tab); }
                if(item.action === 'jeolgi') { window.__showJeolgiCalendar && window.__showJeolgiCalendar(); }
                if(item.action === 'guide') { window.__showSajuGuide && window.__showSajuGuide(); }
                input.value = '';
                results.classList.remove('active');
              });
            });
          }
          results.classList.add('active');
        });

        input.addEventListener('focus', () => {
          if(input.value.trim()) results.classList.add('active');
        });

        document.addEventListener('click', (e) => {
          if(!e.target.closest('.header-search')) results.classList.remove('active');
        });
      }
    };
    document.addEventListener('DOMContentLoaded', () => headerSearch.init());

    // ═══ 최근 변경 사이드바 카드 ═══
    const recentChanges = {
      init() {
        this.render();
        setInterval(() => this.render(), 30000);
      },
      render() {
        const container = document.getElementById('recent-changes-list');
        if (!container) return;

        let people = [];
        try {
          // celebrity DB에서 가져오기
          if (window.__sajuDbManager) {
            const celebs = window.__sajuDbManager.getAll('celebrity') || [];
            const personals = window.__sajuDbManager.getAll('personal') || [];
            people = [
              ...celebs.map(p => ({ ...p, _type: 'celeb' })),
              ...personals.map(p => ({ ...p, _type: 'personal' }))
            ];
          }
        } catch(e) {}

        // addedAt 또는 updatedAt 기준 정렬, 없으면 배열 뒤쪽이 최신
        people.sort((a, b) => {
          const dateA = a.updatedAt || a.addedAt || 0;
          const dateB = b.updatedAt || b.addedAt || 0;
          return dateB - dateA;
        });

        const recent = people.slice(0, 10);

        if (recent.length === 0) {
          container.innerHTML = '<div style="text-align:center;color:var(--text-dim);font-size:0.8rem;padding:8px 0">등록된 인물이 없습니다</div>';
          return;
        }

        container.innerHTML = recent.map(p => {
          const dateStr = p.updatedAt ? new Date(p.updatedAt).toLocaleDateString('ko-KR', {month:'short', day:'numeric'}) :
                         p.addedAt ? new Date(p.addedAt).toLocaleDateString('ko-KR', {month:'short', day:'numeric'}) : '';
          const badge = p.updatedAt && p.addedAt && p.updatedAt !== p.addedAt
            ? '<span class="recent-change-badge edit">수정</span>'
            : '<span class="recent-change-badge new">추가</span>';
          const note = p.note ? `<span class="recent-change-note">${p.note}</span>` : '';
          return `<div class="recent-change-item" data-name="${(p.name||'').replace(/"/g,'&quot;')}">
            ${badge}
            <span class="recent-change-name">${p.name || ''}</span>
            ${note}
            <span class="recent-change-date">${dateStr}</span>
          </div>`;
        }).join('');

        // 클릭 시 인물위키로 이동 및 검색
        container.querySelectorAll('.recent-change-item').forEach(item => {
          item.addEventListener('click', () => {
            const name = item.dataset.name;
            switchTab('celeb');
            const searchInput = document.getElementById('db-search');
            if (searchInput) {
              searchInput.value = name;
              searchInput.dispatchEvent(new Event('input'));
            }
          });
        });
      }
    };
    document.addEventListener('DOMContentLoaded', () => setTimeout(() => recentChanges.init(), 1000));
  </script>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       이용약관 / 개인정보처리방침 모달
       ═══════════════════════════════════════════════════════════════════════════ -->
  <div id="terms-modal" class="legal-modal">
    <div class="legal-modal-content">
      <button class="legal-modal-close" onclick="closeLegalModal()">&times;</button>
      <div class="legal-modal-body" id="terms-modal-body"></div>
    </div>
  </div>

  <script>
    // 이용약관 내용
    const termsContent = `
      <h2>연세사주 이용약관</h2>
      <p class="legal-date"><strong>시행일자: 2026년 2월 4일</strong></p>
      <p>본 약관은 '연세사주'(이하 "서비스")의 이용과 관련하여 운영자와 이용자 간의 권리·의무 및 책임사항, 기타 필요한 사항을 규정함을 목적으로 합니다.</p>
      <hr>

      <h3>제1조(목적)</h3>
      <p>이 약관은 운영자 반우석(이하 "운영자")이 제공하는 연세사주 서비스의 이용조건 및 절차, 운영자와 이용자 간의 권리·의무 및 책임사항을 규정함을 목적으로 합니다.</p>

      <h3>제2조(정의)</h3>
      <ol>
        <li><strong>서비스</strong>: 운영자가 제공하는 사주(명리) 기반 정보 제공 및 관련 기능 일체를 의미합니다.</li>
        <li><strong>이용자</strong>: 본 약관에 따라 서비스를 이용하는 회원 및 비회원을 의미합니다.</li>
        <li><strong>회원</strong>: SNS 로그인(구글/네이버/카카오)을 통해 계정을 생성하여 서비스 이용계약을 체결한 자를 의미합니다.</li>
        <li><strong>비회원</strong>: 로그인 없이 서비스를 이용하는 자를 의미합니다.</li>
        <li><strong>명식정보</strong>: 사주 풀이를 위해 이용자가 입력하는 생년월일시, 이름, 성별 등 정보를 의미합니다.</li>
        <li><strong>콘텐츠</strong>: 서비스에서 제공되는 결과 화면, 문구, 시각화, 구성요소 및 기타 정보 일체를 의미합니다.</li>
      </ol>

      <h3>제3조(약관의 게시 및 개정)</h3>
      <ol>
        <li>운영자는 본 약관을 서비스 내에 게시하거나 기타 합리적인 방법으로 공지합니다.</li>
        <li>운영자는 관련 법령을 위반하지 않는 범위에서 약관을 개정할 수 있습니다.</li>
        <li>약관이 개정되는 경우 시행일 및 개정사유를 명시하여 시행일 7일 전부터 공지합니다. 다만 이용자에게 불리한 내용은 30일 전부터 공지할 수 있습니다.</li>
        <li>이용자가 개정 약관 시행일 이후에도 서비스를 계속 이용하는 경우, 개정 약관에 동의한 것으로 봅니다.</li>
      </ol>

      <h3>제4조(서비스의 제공 및 특징)</h3>
      <ol>
        <li>서비스는 사주(명리) 기반의 정보·해석·참고자료 등을 제공하며, <strong>유료 서비스는 제공하지 않습니다.</strong></li>
        <li>서비스는 회원/비회원 모두 이용할 수 있습니다.</li>
        <li>단, <strong>사주 명식 저장 등 일부 기능은 로그인(회원)에게만 제공</strong>될 수 있습니다.</li>
      </ol>

      <h3>제5조(회원가입 및 SNS 로그인)</h3>
      <ol>
        <li>회원가입은 이용자가 SNS 계정(구글/네이버/카카오)으로 로그인하고, 본 약관 및 개인정보처리방침에 동의함으로써 성립합니다.</li>
        <li>운영자는 필요한 경우 추가 정보(예: 명식 저장을 위한 이름/생년월일시/성별 입력)를 요구할 수 있습니다.</li>
        <li><strong>만 14세 미만</strong> 이용자가 회원 기능을 이용하기 위해 개인정보 제공이 필요한 경우, 관련 법령에 따라 <strong>법정대리인의 동의가 필요</strong>할 수 있습니다.</li>
      </ol>

      <h3>제6조(계정 관리 및 이용 제한)</h3>
      <ol>
        <li>회원은 SNS 로그인 정보 및 본인 인증 수단의 관리책임을 부담하며, 계정의 부정사용이 의심되는 경우 즉시 운영자에게 문의해야 합니다.</li>
        <li>운영자는 다음 각 호에 해당하는 경우 사전 통지 없이 서비스 이용을 제한하거나 중단할 수 있습니다.
          <ol type="a">
            <li>타인의 계정을 도용하거나 부정한 방법으로 이용한 경우</li>
            <li>서비스 운영을 방해하거나 비정상적 트래픽을 유발하는 행위</li>
            <li>법령, 공서양속 또는 본 약관을 위반하는 행위</li>
            <li>기타 운영자가 합리적으로 필요하다고 판단하는 경우</li>
          </ol>
        </li>
      </ol>

      <h3>제7조(이용자의 의무)</h3>
      <p>이용자는 다음 행위를 하여서는 안 됩니다.</p>
      <ol>
        <li>허위정보 입력 또는 타인의 개인정보를 무단으로 입력하는 행위</li>
        <li>서비스 또는 서버/네트워크에 과부하를 유발하거나, 해킹·크롤링·리버스엔지니어링 등 보안 침해 행위</li>
        <li>서비스 콘텐츠를 무단 복제·배포·전송·상업적 이용하는 행위</li>
        <li>운영자 또는 제3자의 명예를 훼손하거나 불법·유해 정보를 게시/유포하는 행위</li>
        <li>기타 법령 또는 본 약관에 위반되는 행위</li>
      </ol>

      <h3>제8조(서비스 제공의 중단)</h3>
      <ol>
        <li>운영자는 시스템 점검, 장애, 천재지변, 통신사고 등 불가피한 사유가 있는 경우 서비스 제공을 일시 중단할 수 있습니다.</li>
        <li>운영자는 가능한 경우 사전에 공지하되, 긴급한 경우 사후 공지할 수 있습니다.</li>
      </ol>

      <h3>제9조(지식재산권)</h3>
      <ol>
        <li>서비스에 포함된 콘텐츠 및 저작물에 대한 권리는 운영자 또는 정당한 권리자에게 귀속됩니다.</li>
        <li>이용자는 운영자의 사전 동의 없이 서비스 콘텐츠를 복제, 배포, 전송, 2차적 저작물 작성, 상업적 이용할 수 없습니다(법령상 허용되는 경우는 제외).</li>
      </ol>

      <h3>제10조(면책 및 책임의 제한)</h3>
      <ol>
        <li>서비스에서 제공되는 사주/운세/해석 등은 <strong>정보 제공 및 참고 목적</strong>이며, 특정 결과(재물, 건강, 연애, 법률, 투자 등)를 보장하지 않습니다.</li>
        <li>운영자는 이용자의 개인적 의사결정(의료·법률·투자 등)에 대해 책임을 지지 않으며, 필요한 경우 전문가 상담을 권장합니다.</li>
        <li>운영자는 무료로 제공되는 서비스의 특성상, 법령상 허용되는 범위 내에서 간접손해, 특별손해 등에 대해 책임을 제한할 수 있습니다.</li>
        <li>다만 운영자의 고의 또는 중대한 과실로 인한 손해에 대해서는 관련 법령에 따릅니다.</li>
      </ol>

      <h3>제11조(분쟁 해결)</h3>
      <ol>
        <li>운영자는 이용자의 정당한 의견이나 불만을 처리하기 위해 노력합니다.</li>
        <li>분쟁이 발생할 경우, 운영자와 이용자는 성실히 협의하여 해결하도록 합니다.</li>
      </ol>

      <h3>제12조(준거법 및 관할)</h3>
      <ol>
        <li>본 약관은 대한민국 법령을 준거법으로 합니다.</li>
        <li>서비스 이용과 관련하여 분쟁이 발생한 경우, 민사소송법상 관할법원을 전속관할로 합니다.</li>
      </ol>

      <h3>제13조(문의)</h3>
      <ul>
        <li>이메일: <a href="mailto:aksd374@yonsei.ac.kr">aksd374@yonsei.ac.kr</a></li>
        <li>전화: 010-4729-8645</li>
      </ul>

      <p class="legal-addendum"><strong>부칙</strong> 본 약관은 2026년 2월 4일부터 시행합니다.</p>
    `;

    // 개인정보처리방침 내용
    const privacyContent = `
      <h2>연세사주 개인정보처리방침</h2>
      <p class="legal-date"><strong>시행일자: 2026년 2월 4일</strong></p>
      <p>운영자 반우석(이하 "운영자")은 「개인정보 보호법」 등 관련 법령을 준수하며, 이용자의 개인정보를 보호하기 위해 다음과 같이 개인정보처리방침을 수립·공개합니다.</p>
      <hr>

      <h3>1. 개인정보의 처리 목적</h3>
      <p>운영자는 다음 목적 범위 내에서 개인정보를 처리합니다.</p>
      <ol>
        <li>사주 서비스 제공(명식 입력값 기반 결과 제공)</li>
        <li>회원 식별, 로그인 유지, 명식 저장/불러오기 등 회원 기능 제공</li>
        <li>문의/민원 처리, 공지사항 전달, 분쟁 대응</li>
        <li>서비스 안정성 확보, 부정 이용 방지, 통계 및 품질 개선</li>
      </ol>

      <h3>2. 처리하는 개인정보 항목 및 수집 방법</h3>

      <h4>(1) 이용자가 직접 입력하는 정보(사주 서비스용)</h4>
      <ul>
        <li><strong>필수(서비스 이용 시 입력될 수 있음)</strong>: 이름, 생년월일, 출생시간, 성별</li>
        <li><strong>비회원 이용 시</strong>: 운영자는 비회원의 입력값을 결과 제공을 위해 <strong>일시적으로 처리</strong>할 수 있으며, 명식 저장 기능을 사용하지 않는 한 <strong>장기 보관을 하지 않도록 운영</strong>합니다(서비스 구조상 보관이 필요한 경우에는 본 방침의 보유기간에 따릅니다).</li>
      </ul>

      <h4>(2) SNS 로그인 시 수집되는 정보(회원 기능 제공)</h4>
      <ul>
        <li><strong>필수</strong>: SNS 계정 식별자(고유 ID 등)</li>
        <li><strong>선택 또는 제공되는 경우</strong>: 이메일, 닉네임(이름), 프로필 이미지</li>
      </ul>
      <p class="legal-note">※ 실제 수집 항목은 이용자가 해당 SNS(구글/네이버/카카오)에서 동의한 범위 및 제공 정책에 따라 달라질 수 있습니다.</p>

      <h4>(3) 자동 수집 정보(서비스 이용 과정에서 생성)</h4>
      <ul>
        <li>접속기록(로그), IP 주소, 쿠키, 기기/브라우저 정보, 이용기록, 오류기록 등</li>
      </ul>

      <h4>(4) 수집 방법</h4>
      <ul>
        <li>웹사이트 입력/제출, SNS 로그인(OAuth 등) 연동, 서비스 이용 과정에서 자동 생성</li>
      </ul>

      <h3>3. 개인정보의 보유 및 이용기간</h3>
      <p>운영자는 원칙적으로 개인정보 처리 목적이 달성되면 지체 없이 파기합니다. 다만 아래의 경우는 예외로 합니다.</p>
      <ol>
        <li><strong>회원정보(SNS 식별자 등)</strong>: 회원 탈퇴 시까지</li>
        <li><strong>저장된 명식정보</strong>: 이용자가 삭제하거나 회원 탈퇴 시까지</li>
        <li><strong>문의/민원 기록</strong>: 처리 완료 후 분쟁 대비를 위해 합리적인 기간 보관 후 파기</li>
        <li><strong>서비스 이용기록/접속기록</strong>: 서비스 안정성 및 보안 목적 달성 후 파기(단, 관련 법령상 보관 의무가 있는 경우 해당 기간 보관)</li>
      </ol>
      <p class="legal-note">※ 운영자가 법령에 따른 보관의무가 있는 항목을 처리하게 되는 경우, 해당 법령에서 정한 기간 동안 보관 후 파기합니다.</p>

      <h3>4. 개인정보의 제3자 제공</h3>
      <p>운영자는 원칙적으로 이용자의 개인정보를 <strong>외부 제3자에게 제공하지 않습니다.</strong></p>
      <p>다만 다음의 경우에는 예외로 할 수 있습니다.</p>
      <ol>
        <li>이용자가 사전에 동의한 경우</li>
        <li>법령에 근거가 있거나, 수사기관 등의 적법한 절차에 따른 요청이 있는 경우</li>
        <li><strong>동일 운영자가 제공하는 연세사주 업그레이드 앱 또는 사주 소개팅 플랫폼 등 "운영자 내부 서비스"와의 연동이 필요한 경우</strong>
          <ul><li>이 경우에도 목적·범위를 최소화하며, 법령상 별도 동의가 필요한 경우 사전에 동의를 받습니다.</li></ul>
        </li>
      </ol>

      <h3>5. 개인정보 처리의 위탁</h3>
      <p>운영자는 원활한 서비스 제공을 위해 개인정보 처리업무를 외부에 위탁할 수 있습니다.</p>
      <p>위탁이 발생하는 경우 운영자는 관련 법령에 따라 위탁계약을 체결하고, 위탁받는 자 및 위탁업무 내용 등을 서비스 내에 공지 또는 본 방침을 통해 공개하겠습니다.</p>
      <p class="legal-note">※ 현재 SNS 로그인 제공을 위해 구글/네이버/카카오 등 외부 인증 서비스를 이용할 수 있으며, 해당 사업자의 개인정보 처리에 관해서는 각 사업자의 정책이 적용됩니다.</p>

      <h3>6. 개인정보의 파기 절차 및 방법</h3>
      <ol>
        <li><strong>파기 절차</strong>: 목적 달성 후 내부 방침에 따라 일정 기간 보관(필요 시) 후 파기합니다.</li>
        <li><strong>파기 방법</strong>
          <ul>
            <li>전자적 파일: 복구 불가능한 방법으로 영구 삭제</li>
            <li>출력물: 분쇄 또는 소각</li>
          </ul>
        </li>
      </ol>

      <h3>7. 이용자 및 법정대리인의 권리와 행사방법</h3>
      <ol>
        <li>이용자는 언제든지 본인 개인정보에 대해 열람, 정정, 삭제, 처리정지, 동의철회(회원탈퇴)를 요청할 수 있습니다.</li>
        <li>요청은 아래 문의처로 접수할 수 있으며, 운영자는 본인 확인 후 지체 없이 처리합니다.</li>
        <li><strong>만 14세 미만 아동</strong>의 경우, 법정대리인이 아동의 개인정보에 관한 권리를 행사할 수 있습니다.</li>
      </ol>

      <h3>8. 개인정보의 안전성 확보조치</h3>
      <p>운영자는 개인정보의 안전성 확보를 위해 다음과 같은 조치를 취합니다.</p>
      <ul>
        <li>접근권한 관리 및 최소한의 인원만 접근</li>
        <li>개인정보 및 인증정보 보호를 위한 기술적 조치(암호화/토큰 처리 등 가능한 범위 내)</li>
        <li>접속기록 보관 및 위·변조 방지</li>
        <li>보안 업데이트 및 취약점 점검(가능한 범위 내)</li>
      </ul>

      <h3>9. 쿠키(Cookie)의 사용</h3>
      <p>운영자는 로그인 유지, 이용환경 개선 등을 위해 쿠키를 사용할 수 있습니다. 이용자는 브라우저 설정을 통해 쿠키 저장을 거부하거나 삭제할 수 있습니다. 다만 쿠키 저장을 거부할 경우 일부 기능(로그인 유지 등)이 제한될 수 있습니다.</p>

      <h3>10. 개인정보 보호책임자 및 문의처</h3>
      <ul>
        <li><strong>개인정보 보호책임자/담당자</strong>: 반우석</li>
        <li><strong>이메일</strong>: <a href="mailto:aksd374@yonsei.ac.kr">aksd374@yonsei.ac.kr</a></li>
        <li><strong>전화</strong>: 010-4729-8645</li>
      </ul>

      <h3>11. 고지의무</h3>
      <p>본 개인정보처리방침의 내용 추가·삭제·수정이 있을 경우, 시행일 7일 전부터 서비스 내 공지 등 합리적인 방법으로 고지합니다.</p>
      <p>본 방침은 <strong>2026년 2월 4일</strong>부터 시행합니다.</p>
    `;

    // 모달 열기
    function openLegalModal(type) {
      const modal = document.getElementById('terms-modal');
      const body = document.getElementById('terms-modal-body');
      body.innerHTML = type === 'terms' ? termsContent : privacyContent;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // 모달 닫기
    function closeLegalModal() {
      const modal = document.getElementById('terms-modal');
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('terms-modal').addEventListener('click', function(e) {
      if (e.target === this) closeLegalModal();
    });

    // ESC 키로 닫기
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeLegalModal();
    });
  </script>
</body>
</html>
